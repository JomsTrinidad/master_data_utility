{% extends "base.html" %}
{% load mdu_extras %}
{% block title %}Propose change{% endblock %}
{% block content %}

<div class="mb-3">
  <div class="text-muted small">Reference</div>
  <h3 class="mb-0">{{ header.ref_name }}</h3>
  <div class="text-muted">Start from the latest approved data, edit rows, then submit.</div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}

      {# Baseline payload used by server to preserve dirty highlights across re-render (Insert New Row) #}
      <input type="hidden" name="baseline_payload_json" value="{{ baseline_payload_json|default:''|escape }}">

      <div class="row g-3">

        <div class="col-md-4">
          <label class="form-label">Tracking ID</label>
          {{ form.tracking_id }}
          <div class="form-text">Hidden most of the time. Kept for audit and loader matching.</div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Override retired</label>
          {{ form.override_retired_flag }}
        </div>

        <div class="col-md-6">
          <label class="form-label">Reason</label>
          {{ form.change_reason }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Ticket</label>
          {{ form.change_ticket_ref }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Category</label>
          {{ form.change_category }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Risk impact</label>
          {{ form.risk_impact }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Source channel</label>
          {{ form.request_source_channel }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Source system</label>
          {{ form.request_source_system }}
        </div>

        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-2">
            <div>
              <div class="text-muted small">Proposed data</div>
              <div class="fw-semibold">Edit business values below</div>
              <div class="text-muted small">Meta fields are steward-controlled. Makers can only update business cells.</div>
            </div>

            <div class="d-flex gap-2 align-items-center">
              {% if is_maker %}
                <button class="btn btn-sm btn-outline-primary" type="submit" name="action" value="add_row">
                  Insert new row
                </button>
              {% endif %}

              <a class="btn btn-sm btn-outline-secondary" href="{% url 'mdu:header_detail' pk=header.pk %}">
                Back to reference
              </a>
            </div>
          </div>

          <div class="table-responsive sticky-table mt-2">
            <table class="table table-sm table-bordered align-middle mdu-edit-table">
              <thead>
                <tr class="sticky-first-row">
                  <th class="text-nowrap">Row Type</th>
                  <th class="text-nowrap">Operation</th>
                  <th class="text-nowrap">Update Row ID</th>

                  {% for c in visible_cols %}
                    <th class="text-nowrap py-1 px-3">
                      <div class="small fw-medium text-body-secondary">{{ col_labels|get_item:c|default:"" }}</div>
                      <div class="small text-body-secondary">[<em>{{ c }}</em>]</div>
                    </th>
                  {% endfor %}
                </tr>
              </thead>

              <tbody class="small">
                {% for r in rows %}
                  <tr class="{% if r.row_type|lower == 'header' %}bg-body-tertiary{% endif %}">
                    <td class="text-nowrap">{{ r.row_type|default:"" }}</td>

                    <td class="text-nowrap meta-locked">
                      <input class="form-control form-control-sm" value="{{ r.operation|default:'' }}" disabled>
                    </td>

                    <td class="text-nowrap meta-locked">
                      <input class="form-control form-control-sm" value="{{ r.update_rowid|default:'' }}" disabled>
                    </td>

                    {% for c in visible_cols %}
                      {# Server-side dirty key uses the SAME row index used in input names (counter0) #}
                      {% with row_index=forloop.parentloop.counter0 %}
                        {% with cell_key=row_index|stringformat:"s"|add:":"|add:c %}
                          {% if is_maker and r.row_type|lower == "values" %}
                            <td class="{% if dirty_cells and dirty_cells|get_item:cell_key %}cell-dirty{% endif %}">
                              <input
                                class="form-control form-control-sm"
                                name="cell__{{ row_index }}__{{ c }}"
                                value="{{ r|get_item:c|default:'' }}"
                                data-orig="{{ r|get_item:c|default:''|escape }}"
                              >
                            </td>
                          {% else %}
                            <td>
                              <input class="form-control form-control-sm" value="{{ r|get_item:c|default:'' }}" disabled>
                            </td>
                          {% endif %}
                        {% endwith %}
                      {% endwith %}
                    {% endfor %}

                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="text-muted small mt-2">
            Tip: Save draft often. Validation happens on submit.
          </div>
        </div>

        {# Keep payload_json in the form submission but hide it from business users #}
        <div class="d-none">
          {{ form.payload_json }}
        </div>

      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a class="btn btn-outline-secondary" href="{% url 'mdu:header_detail' pk=header.pk %}">Cancel</a>
        <button class="btn btn-primary" type="submit">Save draft</button>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
  function isBusinessCellInput(el) {
    return !!(el && el.name && el.name.startsWith("cell__"));
  }

  function markDirty(el) {
    const td = el.closest("td");
    if (!td) return;

    // Prefer server-provided baseline (stable across re-render)
    const orig = (el.dataset.orig !== undefined)
      ? el.dataset.orig
      : (el.getAttribute("data-orig") ?? (el.defaultValue ?? ""));

    el.dataset.orig = orig;

    const now = el.value ?? "";

    if (now !== orig) td.classList.add("cell-dirty");
    else td.classList.remove("cell-dirty");
  }

  document.addEventListener("input", function (e) {
    const el = e.target;
    if (!isBusinessCellInput(el)) return;
    if (el.disabled || el.readOnly) return;
    markDirty(el);
  });
})();
</script>

{% endblock %}
