{% extends "base.html" %}
{% load mdu_extras %}
{% block title %}My Proposed Changes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h3 class="mb-0">My Proposed Changes</h3>
    <div class="text-muted">Drafts, submissions, and decision history.</div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-8">
        <label class="form-label mb-1">Search</label>
        <input class="form-control" name="q" value="{{ q|default:'' }}" placeholder="Search by Display ID or Reference Name">
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button class="btn btn-primary w-100" type="submit">Search</button>
        <a class="btn btn-outline-secondary w-100" href="{% url 'mdu:proposed_change_list' %}">Reset</a>
      </div>
    </form>
  </div>
</div>


{# --- Drafts --- #}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h5 class="mb-0">Drafts</h5>
        <div class="text-muted small">Drafts are editable only when aligned to the latest approved baseline.</div>
      </div>
    </div>

    {% if drafts %}
      <form method="post" action="{% url 'mdu:draft_bulk_delete' %}">
        {% csrf_token %}

        <div class="table-responsive">
          <table class="table table-hover align-middle mdu-table">
            <thead>
              <tr>
                <th class="mdu-col-min"></th>
                <th class="text-nowrap">Display ID</th>
                <th class="text-nowrap">Reference</th>
                <th class="text-nowrap">Workflow</th>
                <th class="text-nowrap">Author</th>
                <th class="text-nowrap">Collaborator Sign-Off</th>
                <th class="text-nowrap">Validity</th>
                <th class="text-nowrap">Created At</th>
                <th class="text-nowrap">Updated At</th>
              </tr>
            </thead>
            <tbody>
              {% for d in drafts %}
                  <tr
                    data-href="{% url 'mdu:proposed_change_detail' pk=d.pk %}"
                    role="button"
                    tabindex="0"
                    class="clickable-row {% if d.pk in drifted_ids %}table-warning{% endif %}">

                    <td class="text-nowrap">
                      {% if d.pk in drifted_ids %}
                        <input class="form-check-input" type="checkbox" name="draft_ids" value="{{ d.pk }}" aria-label="Select drifted draft">
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>

                    <td class="text-nowrap">
                      <div class="fw-semibold">{{ d.display_id }}</div>
                      {% if d.created_by and d.created_by != user %}
                        <div class="text-muted small">Shared draft · Created by {{ d.created_by.username }}</div>
                      {% endif %}
                    </td>

                    <td class="text-nowrap">{{ d.header.ref_name }}</td>

                    <td class="text-nowrap">{{ d.ref_kind_label }}</td>

                    <td class="text-nowrap">{{ d.author_label }}</td>

                    <td class="text-nowrap">{{ d.maker2_status_label }}</td>

                    <td class="text-nowrap">
                      {% if d.pk in drifted_ids %}
                        <span class="badge text-bg-warning">Drifted From Baseline</span>
                        <div class="text-muted small">View-only · delete &amp; recreate to submit</div>
                      {% else %}
                        <span class="badge text-bg-success">Aligned</span>
                        <div class="text-muted small">Editable</div>
                      {% endif %}
                    </td>

                    <td class="text-nowrap">{{ d.created_at|date:"Y-m-d H:i" }}</td>

                    <td class="text-nowrap">{{ d.updated_at|date:"Y-m-d H:i" }}</td>
                  </tr>
{% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-outline-danger">Delete Selected Drifted Drafts</button>
          <div class="text-muted small align-self-center">Only drifted drafts can be bulk deleted from here.</div>
        </div>
      </form>
    {% else %}
      <div class="text-muted">No drafts found.</div>
    {% endif %}
  </div>
</div>


{# --- Submitted --- #}
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="mb-0">Submitted</h5>
    <div class="text-muted small mb-2">Waiting for a decision.</div>

    {% if submitted %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mdu-table">
          <thead>
            <tr>
              <th class="text-nowrap">Display ID</th>
              <th class="text-nowrap">Reference</th>
                <th class="text-nowrap">Workflow</th>
                <th class="text-nowrap">Author</th>
                <th class="text-nowrap">Collaborator Sign-Off</th>
              <th class="text-nowrap">Submitted At</th>
            </tr>
          </thead>
          <tbody>
            {% for s in submitted %}
              <tr data-href="{% url 'mdu:proposed_change_detail' pk=s.pk %}" role="button" tabindex="0" class="clickable-row">
                <td class="text-nowrap">
                  <div class="fw-semibold">{{ s.display_id }}</div>
                </td>
                <td class="text-nowrap">{{ s.header.ref_name }}</td>
                <td class="text-nowrap">{{ s.ref_kind_label }}</td>
                <td class="text-nowrap">{{ s.author_label }}</td>
                <td class="text-nowrap">{{ s.maker2_status_label }}</td>
                <td class="text-nowrap">{{ s.submitted_at|date:"Y-m-d H:i"|default:"—" }}</td>
              </tr>
{% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No submitted changes found.</div>
    {% endif %}
  </div>
</div>


{# --- Decisioned --- #}
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-0">Decisioned</h5>
    <div class="text-muted small mb-2">Approved or rejected history.</div>

    {% if decisioned %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mdu-table">
          <thead>
            <tr>
              <th class="text-nowrap">Display ID</th>
              <th class="text-nowrap">Reference</th>
                <th class="text-nowrap">Workflow</th>
                <th class="text-nowrap">Author</th>
                <th class="text-nowrap">Collaborator Sign-Off</th>
              <th class="text-nowrap">Final Status</th>
              <th class="text-nowrap">Decided At</th>
            </tr>
          </thead>
          <tbody>
            {% for d in decisioned %}
              <tr data-href="{% url 'mdu:proposed_change_detail' pk=d.pk %}" role="button" tabindex="0" class="clickable-row">
                <td class="text-nowrap">
                  <div class="fw-semibold">{{ d.display_id }}</div>
                </td>
                <td class="text-nowrap">{{ d.header.ref_name }}</td>
                <td class="text-nowrap">{{ d.ref_kind_label }}</td>
                <td class="text-nowrap">{{ d.author_label }}</td>
                <td class="text-nowrap">{{ d.maker2_status_label }}</td>
                <td class="text-nowrap">
                  {% if d.status == 'APPROVED' %}
                    <span class="badge text-bg-success">Approved</span>
                  {% elif d.status == 'REJECTED' %}
                    <span class="badge text-bg-danger">Rejected</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{{ d.get_status_display }}</span>
                  {% endif %}
                </td>
                <td class="text-nowrap">{{ d.decided_at|date:"Y-m-d H:i"|default:"—" }}</td>
              </tr>
{% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No decisioned changes found.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
