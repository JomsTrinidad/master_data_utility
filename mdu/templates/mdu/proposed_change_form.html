{% extends "base.html" %}
{% load mdu_extras %}
{% load static %}
{% block title %}Propose Change{% endblock %}
{% block content %}


<div style="display:none" data-editing="{% if editing %}1{% else %}0{% endif %}" id="editingFlag"></div>

<div class="mb-3">
  <div class="text-muted small">Reference</div>
  <h3 class="mb-0">{{ header.ref_name }}</h3>
  <div class="text-muted">Start From The Latest Approved Data, Edit Rows, Then Submit.</div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" id="proposeForm">
      {% csrf_token %}

      <input type="hidden" name="baseline_payload_json" id="baselinePayload" value="{{ baseline_payload_json|default:''|escape }}">
      
      {% if editing %}
        <input type="hidden" name="draft_uuid" value="{{ ch.draft_uuid }}">
        <input type="hidden" name="lock_version" value="{{ ch.lock_version }}">
      {% endif %}



      <input type="hidden" id="baselineUpdateIds" value="{{ baseline_update_ids_json|default:'{}'|escape }}">

      
      <input type="hidden" name="request_overview_open" id="requestOverviewOpen" value="{{ request_overview_open|default:'1' }}">

      <input type="hidden" name="save_next" id="saveNext" value="stay">

      <div id="draftUxMeta"
      data-focus-row-index="{{ focus_row_index|default_if_none:'' }}"
      data-rows-added-count="{{ rows_added_count|default:0 }}"
      style="display:none;">
      </div>

      <div class="row g-3">

        <!-- Request Overview (Accordion) -->
        <div class="col-12">
          <div class="accordion mdu-request-overview" id="requestOverviewAccordion">
            <div class="accordion-item">

              <h2 class="accordion-header" id="headingRequestOverview">
                <button
                  id="requestOverviewToggle"
                  class="accordion-button"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseRequestOverview"
                  aria-expanded="{% if request_overview_open %}true{% else %}false{% endif %}"
                  aria-controls="collapseRequestOverview">
                  Request Overview
                </button>
              </h2>

              <div
                id="collapseRequestOverview"
                class="accordion-collapse collapse {% if request_overview_open %}show{% endif %}"
                aria-labelledby="headingRequestOverview"
                data-bs-parent="#requestOverviewAccordion">

                <div class="accordion-body pt-3">

                  <div class="row g-4">

                    <!-- Row 1: Tracking / Requested / Version / (spacer for alignment) -->
                    <div class="col-md-4">
                      <label class="form-label">Change Tracking ID</label>
                      <input class="form-control form-control-sm" value="{{ form.tracking_id.value }}" readonly>
                      <div class="form-text small">Used For Audit And Loader Matching.</div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Change Ticket Reference</label>
                      <input
                        class="form-control form-control-sm {% if 'change_ticket_ref' in missing_required_fields %}is-invalid{% endif %}"
                        name="change_ticket_ref"
                        id="changeTicketRef"
                        placeholder="ex: Jira-ID 12345"
                        value="{{ form.change_ticket_ref.value|default:''|escape }}"
                        data-orig="{{ form.change_ticket_ref.value|default:''|escape }}"
                      >
                    </div>                    


                    <div class="col-md-4">
                      <label class="form-label">Change Category</label>
                      <div id="changeCategoryWrap" data-orig="{{ form.change_category.value|default:''|escape }}">
                        <select name="change_category"
                                class="form-select form-select-sm {% if 'change_category' in missing_required_fields %}is-invalid{% endif %}">
                          {% for v, lbl in form.fields.change_category.choices %}
                            <option value="{{ v }}" {% if form.change_category.value == v %}selected{% endif %}>{{ lbl }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Requested By SID</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ request.user.username }}" readonly>
                        <input type="hidden" name="requested_by_sid" value="{{ request.user.username|escape }}">
                      {% else %}
                        {{ form.requested_by_sid }}
                      {% endif %}
                    </div>




                    <!-- Row 2: Approvers -->
                    <div class="col-md-4">
                      <label class="form-label">Business Owner SID</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ form.business_owner_sid.value|default:'' }}" readonly>
                        <input type="hidden" name="business_owner_sid" value="{{ form.business_owner_sid.value|default:''|escape }}">
                      {% else %}
                        {{ form.business_owner_sid }}
                      {% endif %}
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Approver AD Group Name</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ form.approver_ad_group.value|default:'' }}" readonly>
                        <input type="hidden" name="approver_ad_group" value="{{ form.approver_ad_group.value|default:''|escape }}">
                      {% else %}
                        {{ form.approver_ad_group }}
                      {% endif %}
                    </div>




                    <!-- Row 3: Reason full width -->
                    <div class="col-12">
                      <label class="form-label">Change Reason</label>
                      <textarea
                        class="form-control form-control-sm {% if 'change_reason' in missing_required_fields %}is-invalid{% endif %}"
                        name="change_reason"
                        id="changeReason"
                        placeholder="Explain the reason for this change request..."
                        rows="3"
                        value=""
                        data-orig="{{ form.change_reason.value|default:''|escape }}"
                      >{{ form.change_reason.value|default:''|escape }}</textarea>
                    </div>

                  </div>

                  {% if editing %}
                    <div class="d-flex justify-content-end gap-2 mt-3">
                      <button class="btn btn-sm btn-outline-danger"
                              type="submit"
                              formmethod="post"
                              formaction="{% url 'mdu:proposed_change_discard' pk=ch.pk %}">
                        Discard Draft
                      </button>
                    </div>
                  {% endif %}

                </div>
              </div>
            </div>
          </div>
        </div>


        {% if messages %}
          <div class="mt-2" id="pageMessages">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show py-2 mb-2" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}




        <!-- Proposed Data Table -->
        <div class="col-12 mt-2">

        <div class="d-flex align-items-center">
          <div>
            <div class="fw-semibold">Proposed Data</div>
            <div class="text-muted small">Edit Business Values Below. Meta Columns Are Locked.</div>
          </div>

          <div class="ms-auto">
            <a class="btn btn-outline-secondary mdu-btn-nav" id="backToReferenceBtn" href="{% url 'mdu:header_detail' pk=header.pk %}">
              <span class="mdu-btn-icon">‚Üê</span> Back To Reference
            </a>
          </div>
        </div>


          <div class="table-responsive sticky-table mt-2" id="proposedDataScroll">

            <table class="table table-sm table-bordered align-middle mdu-edit-table">

              <thead>
                <tr class="sticky-first-row">
                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-1" style="width:44px;"></th>
                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-2">Row Type</th>
                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-3">Operation</th>
                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-4">
                    Change Comment
                    <button
                      type="button"
                      class="btn btn-link btn-sm p-0 ms-1 text-muted mdu-info"
                      data-bs-toggle="tooltip"
                      data-bs-title="Optional. Add context for reviewers. Not used by loaders."
                      aria-label="More info">
                      i
                    </button>
                  </th>

                  {% for c in visible_cols %}
                    <th class="text-nowrap py-1 px-3">
                      <div class="small fw-medium text-body-secondary">{{ col_labels|get_item:c|default:"" }}</div>
                      <div class="small text-body-secondary">[<em>{{ c }}</em>]</div>
                    </th>
                  {% endfor %}
                </tr>
              </thead>


              <tbody class="small">
                {% for r in rows %}
                  {% with row_index=forloop.counter0 %}
                  <tr
                    {% if r.row_type|lower == "values" %}
                      id="row-{{ row_index }}"
                    {% endif %}
                    class="{% if r.row_type|lower == 'header' %}bg-body-tertiary{% endif %}"
                  >

                    <!-- Trash / Undo (first column) -->
                    <td class="text-nowrap mdu-sticky-col mdu-sticky-col-1">
                      {% if r.row_type|lower == "values" and is_maker %}
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary mdu-row-toggle-delete"
                                data-row-index="{{ row_index }}"
                                aria-label="Retire Row">
                          üóë
                        </button>
                        <input type="hidden"
                              id="rowDelete-{{ row_index }}"
                              name="row_delete__{{ row_index }}"
                              value="{% if r.operation|default:''|upper == 'RETIRE ROW' %}1{% else %}0{% endif %}">
                      {% endif %}
                    </td>

                    <!-- Row Type -->
                    <td class="text-nowrap mdu-sticky-col mdu-sticky-col-2">{{ r.row_type|default:"" }}</td>

                    <!-- Operation (UI label, derived; never editable) -->
                    <td class="text-nowrap meta-locked mdu-sticky-col mdu-sticky-col-3 mdu-op-col">
                      <input class="form-control form-control-sm text-start {% if r.operation|default:''|upper == 'RETIRE ROW' %}text-danger{% endif %}"
                            style="min-width: 10rem;"
                            id="opLabel-{{ row_index }}"
                            value="{% if r.row_type|lower == 'header' %}‚Äî{% endif %}"
                            readonly>
                      <input type="hidden"
                            id="opCode-{{ row_index }}"
                            name="op__{{ row_index }}"
                            value="{{ r.operation|default:''|upper }}">
                    </td>

                    <!-- Update Row ID is system-owned (hidden). UI shows Change Comment instead. -->
                    <td class="text-nowrap meta-locked mdu-sticky-col mdu-sticky-col-4">
                      <input type="hidden"
                            id="updateRowId-{{ row_index }}"
                            name="update_rowid__{{ row_index }}"
                            value="{{ r.update_rowid|default:'' }}">

                      {% if r.row_type|lower == 'header' %}
                        <input class="form-control form-control-sm" value="‚Äî" readonly>
                      {% else %}
                        <textarea
                          class="form-control form-control-sm business-cell change-comment-cell {% if dirty_cells|get_item:row_index|get_item:'change_comment' %}mdu-dirty{% endif %}"
                          id="changeComment-{{ row_index }}"
                          name="change_comment__{{ row_index }}"
                          rows="1"
                          data-row-index="{{ row_index }}"
                          data-orig="{{ r.change_comment|default:''|escape }}"
                        >{{ r.change_comment|default:''|escape }}</textarea>
                      {% endif %}
                    </td>

                    {% for c in visible_cols %}
                      {% if is_maker and r.row_type|lower == "values" %}
                        <td>
                          <input
                            class="form-control form-control-sm business-cell {% if dirty_cells|get_item:row_index|get_item:c %}mdu-dirty{% endif %}"
                            name="cell__{{ row_index }}__{{ c }}"
                            value="{{ r|get_item:c|default:'' }}"
                            data-orig="{{ r|get_item:c|default:''|escape }}"
                            data-row-index="{{ row_index }}"
                            data-col="{{ c }}"
                            {% if r.operation|default:''|upper == 'RETIRE ROW' %}readonly{% endif %}
                          >
                        </td>
                      {% else %}
                        <td>
                          <input class="form-control form-control-sm" value="{{ r|get_item:c|default:'' }}" disabled>
                        </td>
                      {% endif %}
                    {% endfor %}
                  </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>


              
            </table>
          </div>


          {% if rows_added_count and rows_added_count|add:0 > 0 %}
            <div class="alert alert-info py-2 mt-2 mb-0" role="alert" id="rowsAddedNotice">
              {{ rows_added_count }} Row{% if rows_added_count|add:0 != 1 %}s{% endif %} Added.
            </div>
          {% endif %}



          <hr class="my-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-primary" type="submit" name="action" value="add_row">
                + Add New Row
              </button>

              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
                Populate Table From A File
              </button>
            </div>

            <div class="d-flex align-items-center gap-2">
              <a class="btn btn-outline-secondary mdu-btn-nav" id="cancelBtn" href="{% url 'mdu:header_detail' pk=header.pk %}">
                <span class="mdu-btn-icon">‚Üê</span> Cancel
              </a>

              <button class="btn btn-outline-primary" type="button" id="saveDraftBtn" disabled
                      data-bs-toggle="modal" data-bs-target="#saveDraftModal">
                Save Draft
              </button>

              {% if editing %}
              {# Progressive affordance: only enable submit after at least one save (editing screen) #}
              <span id="submitBtnWrap" class="d-inline-block">
                <button class="btn btn-primary" type="button" id="submitBtn" disabled
                        data-bs-toggle="modal" data-bs-target="#submitConfirmModal">
                  Submit For Approval
                </button>
              </span>
              {% endif %}

            </div>

            <div class="small text-muted mt-1 {% if missing_required_fields %}{% else %}d-none{% endif %}" id="submitHelp">
              Complete required fields to submit.
            </div>
          
          </div>





          <div class="modal fade" id="saveDraftModal" tabindex="-1" aria-labelledby="saveDraftModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="saveDraftModalLabel">Draft Saved</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                  <div class="text-muted">You can keep editing or return to the reference page.</div>
                </div>

                <div class="modal-footer d-flex justify-content-between">
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="saveDraftStayBtn">Keep Editing</button>
                    <button type="button" class="btn btn-outline-secondary" id="saveDraftBackBtn">Return To Reference</button>
                  </div>
                  <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">Close</button>
                </div>

              </div>
            </div>
          </div>



          <div class="modal fade" id="submitConfirmModal" tabindex="-1" aria-labelledby="submitConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="submitConfirmModalLabel">Submit request?</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                  <div class="mb-1">You won‚Äôt be able to edit once submitted.</div>
                  <div class="text-muted small">Please confirm you‚Äôre ready to send this for approval.</div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Go Back</button>

                  {# IMPORTANT: update this URL name to your actual submit endpoint #}
                  {% if editing %}
                    <button type="submit"
                            class="btn btn-primary"
                            form="proposeForm"
                            formmethod="post"
                            formaction="{% url 'mdu:proposed_change_submit' pk=ch.pk %}">
                      Submit
                    </button>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>

          <div class="d-none">
            {{ form.payload_json }}
          </div>

        </div>

      </div>

    </form>
  </div>
</div>





<div class="modal fade" id="bulkUploadModal" tabindex="-1" aria-labelledby="bulkUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="bulkUploadModalLabel">Populate Table From A File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="text-muted small">
          Download the template, fill it out, then upload it here. Rows will appear in the table (nothing is submitted yet).
        </div>

        <div class="mt-3">
          <a class="small" href="{% url 'mdu:bulk_template_csv' header.pk %}">Download Template</a>
        </div>

        <div class="mt-3">
          <label class="form-label">CSV File</label>
          <input type="file" id="bulkCsvInput" name="bulk_csv" accept=".csv,text/csv" class="form-control" form="proposeForm">
          <div class="form-text small">Only use the downloaded template for this reference.</div>
        </div>

        <div class="alert alert-warning py-2 mt-3 mb-0 small">
          Tip: If nothing happens after upload, the file is usually missing values or has extra columns.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="bulkUploadBtn" type="submit" name="action" value="bulk_upload" form="proposeForm" disabled>
          Populate Table
        </button>
      </div>

    </div>
  </div>
</div>


{{ dirty_cells|json_script:"dirtyCellsJson" }}




<script src="{% static 'mdu/js/propose_change.js' %}"></script>




{% endblock %}