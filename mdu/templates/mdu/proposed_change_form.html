{% extends "base.html" %}
{% load mdu_extras %}
{% block title %}Propose Change{% endblock %}
{% block content %}


<div style="display:none" data-editing="{% if editing %}1{% else %}0{% endif %}" id="editingFlag"></div>

<div class="mb-3">
  <div class="text-muted small">Reference</div>
  <h3 class="mb-0">{{ header.ref_name }}</h3>
  <div class="text-muted">Start From The Latest Approved Data, Edit Rows, Then Submit.</div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" id="proposeForm">
      {% csrf_token %}

      <input type="hidden" name="baseline_payload_json" id="baselinePayload" value="{{ baseline_payload_json|default:''|escape }}">

      <input type="hidden" name="request_overview_open" id="requestOverviewOpen" value="{% if request_overview_open %}1{% else %}0{% endif %}">

      <input type="hidden" name="save_next" id="saveNext" value="stay">

      <div id="draftUxMeta"
      data-focus-row-index="{{ focus_row_index|default_if_none:'' }}"
      data-rows-added-count="{{ rows_added_count|default:0 }}"
      style="display:none;">
      </div>

      <div class="row g-3">

        <!-- Request Overview (Accordion) -->
        <div class="col-12">
          <div class="accordion" id="requestOverviewAccordion">
            <div class="accordion-item">

              <h2 class="accordion-header" id="headingRequestOverview">
                <div class="d-flex align-items-center justify-content-between w-100">

                  <button
                    id="requestOverviewToggle"
                    class="accordion-button"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseRequestOverview"
                    aria-expanded="{% if request_overview_open %}true{% else %}false{% endif %}"
                    aria-controls="collapseRequestOverview">
                    Request Overview — Click To Collapse
                  </button>



                </div>
              </h2>

              <div
                id="collapseRequestOverview"
                class="accordion-collapse collapse {% if request_overview_open %}show{% endif %}"
                aria-labelledby="headingRequestOverview"
                data-bs-parent="#requestOverviewAccordion">

                <div class="accordion-body pt-3">

                  <div class="row g-3 align-items-end">

                    <!-- Row 1: Tracking / Requested / Version / (spacer for alignment) -->
                    <div class="col-lg-4">
                      <label class="form-label">Change Tracking Id</label>
                      <input class="form-control form-control-sm" value="{{ form.tracking_id.value }}" readonly>
                      <div class="form-text small">Used For Audit And Loader Matching.</div>
                    </div>

                    <div class="col-lg-3">
                      <label class="form-label">Requested By Sid</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ request.user.username }}" readonly>
                        <input type="hidden" name="requested_by_sid" value="{{ request.user.username|escape }}">
                      {% else %}
                        {{ form.requested_by_sid }}
                      {% endif %}
                    </div>

                    <div class="col-lg-2">
                      <label class="form-label">Version</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ form.version.value|default:'' }}" readonly>
                        <input type="hidden" name="version" value="{{ form.version.value|default:''|escape }}">
                      {% else %}
                        {{ form.version }}
                      {% endif %}
                    </div>



                    <!-- Row 2: Approvers -->
                    <div class="col-lg-3">
                      <label class="form-label">Primary Approver Sid</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ form.primary_approver_sid.value|default:'' }}" readonly>
                        <input type="hidden" name="primary_approver_sid" value="{{ form.primary_approver_sid.value|default:''|escape }}">
                      {% else %}
                        {{ form.primary_approver_sid }}
                      {% endif %}
                    </div>

                    <div class="col-lg-3">
                      <label class="form-label">Secondary Approver Sid</label>
                      {% if is_maker and not is_steward and not is_approver %}
                        <input class="form-control form-control-sm" value="{{ form.secondary_approver_sid.value|default:'' }}" readonly>
                        <input type="hidden" name="secondary_approver_sid" value="{{ form.secondary_approver_sid.value|default:''|escape }}">
                      {% else %}
                        {{ form.secondary_approver_sid }}
                      {% endif %}
                    </div>

                    <div class="col-lg-3">
                      <label class="form-label">Change Ticket Reference</label>
                      <input
                        class="form-control form-control-sm"
                        name="change_ticket_ref"
                        id="changeTicketRef"
                        placeholder="ex: Jira-ID 12345"
                        value="{{ form.change_ticket_ref.value|default:''|escape }}"
                        data-orig="{{ form.change_ticket_ref.value|default:''|escape }}"
                      >
                    </div>

                    <div class="col-lg-3">
                      <label class="form-label">Change Category</label>
                      <div id="changeCategoryWrap" data-orig="{{ form.change_category.value|default:''|escape }}">
                        {{ form.change_category }}
                      </div>
                    </div>

                    <!-- Row 3: Reason full width -->
                    <div class="col-12">
                      <label class="form-label">Change Reason</label>
                      <textarea
                        class="form-control form-control-sm"
                        name="change_reason"
                        id="changeReason"
                        rows="3"
                        value=""
                        data-orig="{{ form.change_reason.value|default:''|escape }}"
                      >{{ form.change_reason.value|default:''|escape }}</textarea>
                    </div>

                  </div>

                  {% if editing %}
                    <div class="d-flex justify-content-end gap-2 mt-3">
                      <button class="btn btn-sm btn-outline-danger"
                              type="submit"
                              formmethod="post"
                              formaction="{% url 'mdu:proposed_change_discard' pk=ch.pk %}">
                        Discard Draft
                      </button>
                    </div>
                  {% endif %}

                </div>
              </div>
            </div>
          </div>
        </div>


        {% if messages %}
          <div class="mt-2" id="pageMessages">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show py-2 mb-2" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}




        <!-- Proposed Data Table -->
        <div class="col-12 mt-2">

        <div class="d-flex align-items-center">
          <div>
            <div class="fw-semibold">Proposed Data</div>
            <div class="text-muted small">Edit Business Values Below. Meta Columns Are Locked.</div>
          </div>

          <div class="ms-auto">
            <a class="btn btn-sm btn-outline-secondary" id="backToReferenceBtn" href="{% url 'mdu:header_detail' pk=header.pk %}">
              Back To Reference
            </a>
          </div>
        </div>


          <div class="table-responsive sticky-table mt-2">
            <table class="table table-sm table-bordered align-middle mdu-edit-table">
              <thead>
                <tr class="sticky-first-row">

                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-1">Row Type</th>
                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-2">Operation</th>
                  <th class="text-nowrap mdu-sticky-col mdu-sticky-col-3">Update Row Id</th>


                  {% for c in visible_cols %}
                    <th class="text-nowrap py-1 px-3">
                      <div class="small fw-medium text-body-secondary">{{ col_labels|get_item:c|default:"" }}</div>
                      <div class="small text-body-secondary">[<em>{{ c }}</em>]</div>
                    </th>
                  {% endfor %}
                </tr>
              </thead>

              <tbody class="small">
                {% for r in rows %}
                  <tr
                    {% if r.row_type|lower == "values" %}
                      id="row-{{ forloop.counter0 }}"
                    {% endif %}
                    class="{% if r.row_type|lower == 'header' %}bg-body-tertiary{% endif %}">


                    <td class="text-nowrap mdu-sticky-col mdu-sticky-col-1">{{ r.row_type|default:"" }}</td>

                    <td class="text-nowrap meta-locked mdu-sticky-col mdu-sticky-col-2">
                      <input class="form-control form-control-sm" value="{{ r.operation|default:'' }}" disabled>
                    </td>

                    <td class="text-nowrap meta-locked mdu-sticky-col mdu-sticky-col-3">
                      <input class="form-control form-control-sm" value="{{ r.update_rowid|default:'' }}" disabled>
                    </td>

                    {% for c in visible_cols %}
                      {% with row_index=forloop.parentloop.counter0 %}
                        {% if is_maker and r.row_type|lower == "values" %}
                          <td>
                            <input
                              class="form-control form-control-sm business-cell {% if dirty_cells|get_item:row_index|get_item:c %}mdu-dirty{% endif %}"
                              name="cell__{{ row_index }}__{{ c }}"
                              value="{{ r|get_item:c|default:'' }}"
                              data-orig="{{ r|get_item:c|default:''|escape }}"
                            >
                          </td>
                        {% else %}
                          <td>
                            <input class="form-control form-control-sm" value="{{ r|get_item:c|default:'' }}" disabled>
                          </td>
                        {% endif %}
                      {% endwith %}
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>


          {% if rows_added_count and rows_added_count|add:0 > 0 %}
            <div class="alert alert-info py-2 mt-2 mb-0" role="alert" id="rowsAddedNotice">
              {{ rows_added_count }} Row{% if rows_added_count|add:0 != 1 %}s{% endif %} Added.
            </div>
          {% endif %}



          <hr class="my-3">


          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-primary" type="submit" name="action" value="add_row">
                + Add New Row
              </button>

              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
                Populate Table From A File
              </button>
            </div>

            <div class="d-flex align-items-center gap-2">
              <a class="btn btn-link text-muted px-2" id="cancelBtn" href="{% url 'mdu:header_detail' pk=header.pk %}">
                Cancel
              </a>

              <button class="btn btn-outline-primary" type="button" id="saveDraftBtn" disabled
                      data-bs-toggle="modal" data-bs-target="#saveDraftModal">
                Save Draft
              </button>

              {% if editing %}
              {# Progressive affordance: only enable submit after at least one save (editing screen) #}
              <button class="btn btn-primary" type="button" id="submitBtn" disabled
                      data-bs-toggle="modal" data-bs-target="#submitConfirmModal">
                Submit For Approval
              </button>
              {% endif %}

            </div>

            <div class="small text-muted mt-1" id="submitHelp">
              Complete required fields to submit.
            </div>




          </div>



          <div class="modal fade" id="saveDraftModal" tabindex="-1" aria-labelledby="saveDraftModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="saveDraftModalLabel">Draft Saved</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                  <div class="text-muted">You can keep editing or return to the reference page.</div>
                </div>

                <div class="modal-footer d-flex justify-content-between">
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="saveDraftStayBtn">Keep Editing</button>
                    <button type="button" class="btn btn-outline-secondary" id="saveDraftBackBtn">Return To Reference</button>
                  </div>
                  <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">Close</button>
                </div>

              </div>
            </div>
          </div>



          <div class="modal fade" id="submitConfirmModal" tabindex="-1" aria-labelledby="submitConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="submitConfirmModalLabel">Submit request?</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                  <div class="mb-1">You won’t be able to edit once submitted.</div>
                  <div class="text-muted small">Please confirm you’re ready to send this for approval.</div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Go Back</button>

                  {# IMPORTANT: update this URL name to your actual submit endpoint #}
                  {% if editing %}
                    <button type="submit"
                            class="btn btn-primary"
                            form="proposeForm"
                            formmethod="post"
                            formaction="{% url 'mdu:proposed_change_submit' pk=ch.pk %}">
                      Submit
                    </button>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>







          <div class="d-none">
            {{ form.payload_json }}
          </div>

        </div>

      </div>

    </form>
  </div>
</div>

<div class="modal fade" id="bulkUploadModal" tabindex="-1" aria-labelledby="bulkUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="bulkUploadModalLabel">Populate Table From A File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="text-muted small">
          Download the template, fill it out, then upload it here. Rows will appear in the table (nothing is submitted yet).
        </div>

        <div class="mt-3">
          <a class="small" href="{% url 'mdu:bulk_template_csv' header.pk %}">Download Template</a>
        </div>

        <div class="mt-3">
          <label class="form-label">CSV File</label>
          <input type="file" id="bulkCsvInput" name="bulk_csv" accept=".csv,text/csv" class="form-control" form="proposeForm">
          <div class="form-text small">Only use the downloaded template for this reference.</div>
        </div>

        <div class="alert alert-warning py-2 mt-3 mb-0 small">
          Tip: If nothing happens after upload, the file is usually missing values or has extra columns.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="bulkUploadBtn" type="submit" name="action" value="bulk_upload" form="proposeForm" disabled>
          Populate Table
        </button>
      </div>

    </div>
  </div>
</div>

{{ dirty_cells|json_script:"dirtyCellsJson" }}

<script>
(function () {
  function $(id) { return document.getElementById(id); }

  function parseJsonHidden(id) {
    const el = $(id);
    if (!el) return null;
    try { return JSON.parse(el.value || "{}"); } catch (e) { return null; }
  }

  // Elements
  const form = $("proposeForm");
  const saveBtn = $("saveDraftBtn");

  const accordionToggle = $("requestOverviewToggle");
  const collapseEl = $("collapseRequestOverview");
  const openInput = $("requestOverviewOpen");

  const backBtn = $("backToReferenceBtn");
  const cancelBtn = $("cancelBtn");

  const bulkCsvInput = $("bulkCsvInput");
  const bulkUploadBtn = $("bulkUploadBtn");
  const bulkModal = $("bulkUploadModal");

  const meta = $("draftUxMeta");
  const rowsAddedCount = meta ? parseInt(meta.getAttribute("data-rows-added-count") || "0", 10) : 0;
  const focusRowIndexRaw = meta ? (meta.getAttribute("data-focus-row-index") || "") : "";
  const focusRowIndex = focusRowIndexRaw === "" ? null : parseInt(focusRowIndexRaw, 10);

  // Save Draft modal elements
  const saveNext = $("saveNext");                 // hidden input name="save_next"
  const saveModalEl = $("saveDraftModal");        // modal id
  const saveStayBtn = $("saveDraftStayBtn");      // Keep Editing
  const saveBackBtn = $("saveDraftBackBtn");      // Return To Reference

  // ---------- Accordion label + open state ----------
  function setAccordionLabel(isExpanded) {
    if (!accordionToggle) return;
    accordionToggle.textContent = isExpanded
      ? "Request Overview — Click To Collapse"
      : "Request Overview — Click To Expand";
  }

  function setAccordionOpenHidden(isExpanded) {
    if (openInput) openInput.value = isExpanded ? "1" : "0";
  }

  if (collapseEl) {
    collapseEl.addEventListener("shown.bs.collapse", function () {
      setAccordionLabel(true);
      setAccordionOpenHidden(true);
    });
    collapseEl.addEventListener("hidden.bs.collapse", function () {
      setAccordionLabel(false);
      setAccordionOpenHidden(false);
    });

    const isExpanded = collapseEl.classList.contains("show");
    setAccordionLabel(isExpanded);
    setAccordionOpenHidden(isExpanded);
  }

  // ---------- Bulk upload button enable/disable ----------
  function syncBulkUploadBtn() {
    if (!bulkUploadBtn) return;
    const ok = !!(bulkCsvInput && bulkCsvInput.files && bulkCsvInput.files.length > 0);
    bulkUploadBtn.disabled = !ok;
  }

  if (bulkCsvInput) bulkCsvInput.addEventListener("change", syncBulkUploadBtn);

  if (bulkModal) {
    bulkModal.addEventListener("shown.bs.modal", syncBulkUploadBtn);
    bulkModal.addEventListener("hidden.bs.modal", function () {
      if (bulkCsvInput) bulkCsvInput.value = "";
      syncBulkUploadBtn();
    });
  }

  syncBulkUploadBtn();

  // ---------- Baseline-driven dirty ----------
  const baselineObj = parseJsonHidden("baselinePayload") || {};
  const baselineRows = Array.isArray(baselineObj.rows) ? baselineObj.rows : [];

  function baselineValue(rowIndex, col) {
    const r = baselineRows[rowIndex];
    if (!r) return null; // new row not in baseline
    const v = r[col];
    return (v === undefined || v === null) ? "" : String(v);
  }

  function recomputeAllDirty() {
    const inputs = document.querySelectorAll("input.business-cell");
    for (const input of inputs) {
      const name = input.getAttribute("name") || "";
      const m = name.match(/^cell__(\d+)__(string_\d{2})$/);
      if (!m) continue;

      const rowIndex = parseInt(m[1], 10);
      const col = m[2];
      const base = baselineValue(rowIndex, col);
      const now = (input.value ?? "");

      let isDirty = false;
      if (base === null) isDirty = now.trim() !== "";
      else isDirty = now !== base;

      if (isDirty) input.classList.add("mdu-dirty");
      else input.classList.remove("mdu-dirty");
    }
  }

  // ---------- Save Draft enable/disable ----------
  function makerFieldsDirty() {
    const reason = $("changeReason");
    const ticket = $("changeTicketRef");
    const wrap = $("changeCategoryWrap");
    const select = wrap ? wrap.querySelector("select") : null;

    const changed = (el) => {
      if (!el) return false;
      const orig = el.getAttribute("data-orig") ?? "";
      return (el.value ?? "") !== orig;
    };

    const catOrig = wrap ? (wrap.getAttribute("data-orig") ?? "") : "";
    const catChanged = select ? ((select.value ?? "") !== catOrig) : false;

    return changed(reason) || changed(ticket) || catChanged;
  }

  function updateSaveDraftState() {
    const anyCellDirty = !!document.querySelector("input.business-cell.mdu-dirty");
    const changed = anyCellDirty || makerFieldsDirty();
    if (saveBtn) saveBtn.disabled = !changed;
  }

  document.addEventListener("input", function (e) {
    const el = e.target;
    if (!el) return;

    if (el.classList && el.classList.contains("business-cell")) {
      recomputeAllDirty();
      updateSaveDraftState();
      return;
    }

    if (el.id === "changeReason" || el.id === "changeTicketRef") {
      updateSaveDraftState();
      return;
    }

    if (el.tagName === "SELECT" && el.closest("#changeCategoryWrap")) {
      updateSaveDraftState();
      return;
    }
  });

  // Initial compute
  recomputeAllDirty();
  updateSaveDraftState();

  // ---------- Reduce bounce: collapse accordion before add_row / bulk_upload submits ----------
  if (form && collapseEl) {
    form.addEventListener("submit", function (e) {
      const submitter = e.submitter;
      if (!submitter) return;

      const action = submitter.value;
      if (action !== "add_row" && action !== "bulk_upload") return;

      try {
        setAccordionOpenHidden(false);
        const bs = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
        bs.hide();
      } catch (err) {}
    });
  }

  // ---------- Focus newly added row / show notice ----------
  if (focusRowIndex !== null && !Number.isNaN(focusRowIndex)) {
    setTimeout(function () {
      const row = $("row-" + focusRowIndex);
      if (row) {
        row.scrollIntoView({ behavior: "auto", block: "center" });
        const firstCell = row.querySelector("input.business-cell");
        if (firstCell) firstCell.focus();
      }
      const notice = $("rowsAddedNotice");
      if (notice) notice.scrollIntoView({ behavior: "auto", block: "nearest" });
    }, 25);
  }

  // ---------- Save Draft modal actions (THIS is what makes the modal buttons work) ----------
  function hideModal(el) {
    if (!el) return;
    try {
      const inst = bootstrap.Modal.getOrCreateInstance(el);
      inst.hide();
    } catch (e) {}
  }

  function submitDraft(nextVal) {
    if (!form) return;
    if (saveNext) saveNext.value = nextVal; // "stay" or "back"
    hideModal(saveModalEl);
    // submit after modal starts closing to avoid flicker/focus jumps
    setTimeout(function () {
      form.requestSubmit();
    }, 50);
  }

  if (saveStayBtn) {
    saveStayBtn.addEventListener("click", function () { submitDraft("stay"); });
  }
  if (saveBackBtn) {
    saveBackBtn.addEventListener("click", function () { submitDraft("back"); });
  }

  // ---------- Unsaved changes prompt (single handler; no duplicates) ----------
  let navConfirmed = false;

  function isDirtyForNav() {
    if (rowsAddedCount > 0) return true;
    if (document.querySelector("input.business-cell.mdu-dirty")) return true;
    return makerFieldsDirty();
  }

  function bindNavConfirm(el) {
    if (!el) return;
    el.addEventListener("click", function (e) {
      if (navConfirmed) return;
      if (!isDirtyForNav()) return;

      const ok = confirm("You Have Unsaved Changes. Leave This Page Without Saving?");
      if (!ok) {
        e.preventDefault();
        return;
      }
      navConfirmed = true;
    });
  }

  bindNavConfirm(backBtn);
  bindNavConfirm(cancelBtn);
})();
</script>





{% endblock %}
